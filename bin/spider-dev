#!/usr/bin/env bash
########################
# API ##################
########################
# spider-dev [version options] up
#       --orientdb="x.x.x"      Specify version to run
#       --neo4j="x.x.x"         Specify version to run
#       --php="x.x.x"           Specify version to run
#
# spider-dev down       Stops and kills all spider containers
#
# spider-dev [version options] [tests options] test      Runs specific test suites
#       [version options]       See `up`
#       -i                      Run integration tests
#       -u                      Run unit tests
#       (No flag defaults to all tests)
#
# spider-dev [mac flag] [version options] shell        Starts all services and opens a shell session on php
#       --mac                   Flag only if using Mac OSX with the docker native beta (temporarily)
#       [version ooptions]      See `up`
#
# spider-dev version      Outputs the version of spider with the release date, the currently released version of spider, and supported service versions
########################


###### To Do ########
# Have tests or `spider-dev` (I think spider-dev. Tests *should* fail of no service) wait for database service to be up
# spider-dev versions
# find correct directory automatically
####################

### Default Variables
odb_version="2.1.16"
neo_version="2.3.3"
php_version="7.0"

spider_version="0.4.1"
spider_dev_version="0.4.1"

### Supported versions
supported_php="7.0 5.6"
supported_odb="2.1.16 2.1.17 2.2.0"
supported_neo="2.3.3 2.3"


### Paths
SPIDER_PATH=$(pwd)                    # @todo: make this dynamic
SPIDER_BIN_PATH=${SPIDER_PATH}/bin

### Option Defaults
is_mac=0
using_test_flags=0
run_unit_tests=0
run_integration_tests=0

### Loads the dispatch library from  https://github.com/Mosai/workshop/blob/doc/dispatch.md
# Changes zsh globbing patterns
unsetopt NO_MATCH >/dev/null 2>&1 || :

# Dispatches calls of commands and arguments
dispatch ()
{
	namespace="$1"     # Namespace to be dispatched
	arg="${2:-}"       # First argument
	short="${arg#*-}"  # First argument without trailing -
	long="${short#*-}" # First argument without trailing --

	# Exit and warn if no first argument is found
	if [ -z "$arg" ]; then
		"${namespace}_" # Call empty call placeholder
		return 1
	fi

	shift 2 # Remove namespace and first argument from $@

	# Detects if a command, --long or -short option was called
	if [ "$arg" = "--$long" ];then
		longname="${long%%=*}" # Long argument before the first = sign

		# Detects if the --long=option has = sign
		if [ "$long" != "$longname" ]; then
			longval="${long#*=}"
			long="$longname"
			set -- "$longval" "${@:-}"
		fi

		main_call=${namespace}_option_${long}


	elif [ "$arg" = "-$short" ];then
		main_call=${namespace}_option_${short}
	else
		main_call=${namespace}_command_${long}
	fi

	$main_call "${@:-}" && dispatch_returned=$? || dispatch_returned=$?

	if [ $dispatch_returned = 127 ]; then
		"${namespace}_call_" "$namespace" "$arg" # Empty placeholder
		return 1
	fi

	return $dispatch_returned
}

in_array() {
    needle=$1
    haystack=$2
    found="false"

    for item in $haystack
    do
        if [ "$item" = "$needle" ]; then
            found="true"
            break
        fi
    done

    echo "$found"
}

check_versions() {
    is_php_supported=$(in_array $php_version "$supported_php")
    if [ "$is_php_supported" = "false" ]; then
        echo "WARNING: The php version you provided (${php_version}) is not officially supported, and may not have a valid docker container"
    fi

    is_odb_supported=$(in_array $odb_version "$supported_odb")
    if [ "$is_odb_supported" = "false" ]; then
        echo "WARNING: The orientdb version you provided (${odb_version}) is not officially supported, and may not have a valid docker container"
    fi

    is_neo_supported=$(in_array $neo_version "$supported_neo")
    if [ "$is_neo_supported" = "false" ]; then
        echo "WARNING: The neo4j version you provided (${neo_version}) is not officially supported, and may not have a valid docker container"
    fi
}


### Default Commands
spider-dev_ () ( echo "No commands given" ) # A placeholder if not commands were given
spider-dev_call () ( echo "Invalid call '$@'" ) # General error response for command not found



### Active Commands
## UP: spider-dev --orient="x.x" --neo4j="x.x" --php="x.x" --gremlin="x.x" up
spider-dev_command_up () (
    check_versions
    PHP_VERSION=":${php_version}" ORIENTDB_VERSION=":${odb_version}" NEO4J_VERSION=":${neo_version}" docker-compose up -d
)


## DOWN: spider-dev down
spider-dev_command_down () (
    check_versions
    PHP_VERSION=":${php_version}" ORIENTDB_VERSION=":${odb_version}" NEO4J_VERSION=":${neo_version}" docker-compose down
)


## TEST: spider-dev --orient="x.x" --neo4j="x.x" --php="x.x" --gremlin="x.x" -i -u test
spider-dev_command_test () (
    check_versions

    # Create the PHPUnit command
    phpunit_command="/spider/vendor/bin/phpunit -c /spider/phpunit.xml.dist"
    if [ $using_test_flags = 1 ]; then
        phpunit_command="${phpunit_command} "'--filter="'
        if [ $run_unit_tests = 1 ]; then
            phpunit_command="${phpunit_command}Unit|"
        fi

        if [ $run_integration_tests = 1 ]; then
            phpunit_command="${phpunit_command}Integration"
        fi

        phpunit_command="$(echo -e "${phpunit_command}" | sed -e 's/\|*$//')"
        phpunit_command="${phpunit_command}"'"'
    fi

    # Run the tests and kill the container
    spider-dev_command_up
    PHP_VERSION=":${php_version}" docker-compose run php ${phpunit_command}
)


## TEST: spider-dev --orient="x.x" --neo4j="x.x" --php="x.x" --gremlin="x.x" -i -u -a test
spider-dev_command_shell () (
    check_versions

    # Find the correct volume path (temporary workaround for docker native betas)
    if [ $is_mac = 0 ]; then
        volume_path=${SPIDER_PATH}
    else
        volume_path=/Mac${SPIDER_PATH}
    fi

    spider-dev_command_up
    sleep 5
    docker run -it --link spider_orientdb:orientdb --link spider_neo4j:neo4j --net spider_default -e "SPIDER_DOCKER=true" -v ${volume_path}:/spider -w /spider "skooppaos/php:${php_version}" bash
)


## VERSIONS: spider-dev versions
spider-dev_command_versions () (
    echo "Default versions of your development environment: "
    echo " - spider     ${spider_version}"
    echo " - spider-dev ${spider_dev_version}"
    echo " - php        ${php_version}"
    echo " - orientdb   ${odb_version}"
    echo " - neo4j      ${neo_version}"

    echo "Versions currently supported by Spider: "
    echo " - php        ${supported_php}"
    echo " - orientdb   ${supported_odb}"
    echo " - neo4j      ${supported_neo}"
)


# Versioning
spider-dev_option_orientdb () ( odb_version="$1"; shift; dispatch spider-dev "$@" )
spider-dev_option_neo4j () ( neo_version="$1"; shift; dispatch spider-dev "$@" )
spider-dev_option_php () ( php_version="$1"; shift; dispatch spider-dev "$@" )


# Testing Suites Flags
spider-dev_option_u () ( using_test_flags=1; run_unit_tests=1; dispatch spider-dev "$@" )
spider-dev_option_i () ( using_test_flags=1; run_integration_tests=1; dispatch spider-dev "$@" )


# Temporary Mac Flag for shell
spider-dev_option_mac () ( is_mac=1; dispatch spider-dev "$@" )


# Let'er Fly! (Dispatch the arguments)
dispatch spider-dev "$@"
